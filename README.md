# NyanID
サンプルアプリ NyanID(にゃんあいでぃ)は、OAuth認証局サービスです。
承認されるアカウントとサービスの管理を行うものになります。

- NyanQL,Nyan8,NyanPUIの組み合わせによって構成されています。
- 小規模なサービスを運用するのに適しています。
- 登録するアカウントは10名程度を想定しています。
- サービスも10個以内の小規模なものを想定しています。
- 初回起動時の最初のアカウントのログイン名、メールアドレス、パスワードをセットアップすることができます。
- 以降追加されるアカウントのパスワードおよび再発行は自動で生成されます。



# 環境準備
## Windows編 (OSX Linuxについては後日）
SQLiteが動く環境を作成しましょう。
ここでのWindowsとはWindows 11を指します。
### 1) 公式バイナリをダウンロードする
公式ダウンロードページ ( https://www.sqlite.org/download.html )で 
Windows 向けの「Precompiled Binaries for Windows」から sqlite-tools-win32-x86-<version>.zip（コマンドライン用の実行ファイル一式）をダウンロードします。

### 2) ZIP を展開して実行ファイルを置く

- ZIP を右クリック→展開（または任意の解凍ツールで展開）します。
- 中に sqlite3.exe（と sqldiff.exe / sqlite3_analyzer.exe）があるはずです。
- C:\sqlite や C:\Program Files\SQLite のようなフォルダを作ってそこに移動しておくのが分かりやすいです。

>補足：もしダウンロードした ZIP に sqlite3.dll しか入っていない場合は「DLL パッケージ（ライブラリ）」を取ってしまっている可能性があるため、**sqlite-tools-...zip（コマンドラインシェル入り）**を選んでください。


### 3) （推奨）そのフォルダを PATH に追加する

- スタートメニュー→「環境変数」と入力→「システム環境変数を編集」→「環境変数」ボタン。
- 「ユーザー環境変数」または「システム環境変数」の Path を選んで「編集」→「新規」→ C:\sqlite（あなたが置いたパス）を追加→OK。
- 既に開いているコマンドプロンプトは環境変数の変更を読み込まないので、**新しく開き直してください**。

### 4) 動作確認（コマンドプロンプト）
コマンドプロンプト（または PowerShell）を開いて次を実行：

```shell
sqlite3 --version
```

# SMTPサーバーの準備
メール送信のためにSMPTサーバの設定が必要になります。
レンタルサーバ等でSMTPサーバを契約するなど準備をお願いします。

# 設置方法
## (1) リリースファイルをダウンロード
githubのリリースページからNyanIDのzipファイルをダウンロードします。
OSに合わせて最新を選択してください。

## (1)設定ファイルの編集
config.json, api.jsonを編集します。
config.jsonではポート番号、データベースのパス、ログの設定を行います。
api.jsonではエンドポイントの設定を行います。 

## SMTPサーバーの設定
NyanIDはOAuth認証サービスです。
アカウントの登録、パスワードの再発行などでメールを送信します。
SMTPサーバーの設定が必要になりますので、SMTPサーバの情報をご準備ください。

```shell
 設定例 config.jsonより smtp部分抜粋
 "smtp": {
    "host": "smtpのhost名",
    "port": 587,
    "username": "発行したメールアドレス",
    "password": "発行したメールアドレスのパスワード",
    "from_email": "メール送信時のFROM名 発行したメールアドレスと同じになります。",
    "from_name": "NyanID(メール送信元の名前)",
    "tls": false,
    "default_bcc": [
      "メール送信時にBCCでメールを送る先のアドレス" 
    ]
  }
```

## データベースの準備
- NyanQL/NyanId.dbという名前でSQLiteのデータベースファイルを同梱しています。
- Sqliteが動作する環境であれば特に何もせずに動きます。
- データベースを作り直す場合は、NyanQL/createTables.sqlにテーブル作成のSQLを同梱していますので、必要に応じて実行してください。


## (2)SSL証明書の設置
- localで試す場合は不要です。
- 本番環境で利用する場合はSSL証明書を設置してください。
- config.jsonのSSLCertFile, SSLKeyFileに証明書と秘密鍵のパスを設定してください。

## (3)起動
NyanIDの実行ファイルを起動します。
NyanQL, Nyan8, NyanPUIフォルダの中にあるそれぞれ同名の実行ファイルをクリックして起動してください。
http://localhost:8101/ にアクセスしてNyanIDのトップページが表示されれば成功です。

## (4)セットアップの実行
http://localhost:8101/init にアクセスしてセットアップを実行します。
セットアップでは管理者アカウントの登録を行います。
セットアップが完了したら、管理者アカウントでログイン( http://localhost:8101/login )してください。


# NyanIDの使い方
## (1)アカウントの管理
アカウントの管理が可能です。アカウントを新規登録し利用可能なサービスを選択してください。
このNyanIDを起動直後に選択可能なサービス使えるのはNyanIDそのものだけになります。

## (2)サービスの管理
サービスを追加削除編集することができます。
NyanIDを削除するとこのサービスそのものも利用できなくなりますのでご注意ください。

## (3)パスワードの再発行について
パスワードは、忘れた場合に再発行することができます。
ログイン画面の「パスワードを忘れた場合」から登録したメールアドレスを入力してください。
自動発行されたパスワードが送信されます。